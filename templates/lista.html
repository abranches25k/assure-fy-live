<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASSURE FY - Dashboard</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .navbar { background-color: #007bff; }
        .navbar-brand { font-size: 1.8rem !important; font-weight: 900; }
        .navbar-brand img { height: 60px !important; border: none !important; outline: none !important; } 
        .navbar-text, .navbar-nav .nav-link { color: white !important; }
        .btn-warning { color: black; }
        .task-limit { font-size: 1.1em; font-weight: bold; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('lista_tarefas') }}">
                {% if user_logo_path %}
                <img src="{{ url_for('static', filename=user_logo_path) }}" alt="{{ current_user.nome_empresa }}" style="height: 60px;">
                {% else %}
                <img src="{{ url_for('static', filename='img/logo_icon.png') }}" alt="Logo Padrão" style="height: 60px;">
                {% endif %}
            </a>
            <div class="ms-auto d-flex align-items-center">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('planos') }}" class="btn btn-light btn-sm me-2">Ver Planos</a>
                    <span class="navbar-text me-3 text-white task-limit">
                        TAREFAS: {{ tarefas|length }} / {{ current_user.limite_tarefas }}
                    </span>
                    <a href="{{ url_for('perfil') }}" class="btn btn-light btn-sm me-2">Perfil/Logo</a>
                    {% if current_user.email == "qualify.relatorios@gmail.com" %}
                        <a href="{{ url_for('admin_logs') }}" class="btn btn-sm btn-light me-2">Logs Admin</a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Sair ({{ current_user.nome_empresa }})</a>
                {% endif %}
            </div>
        </div>
    </nav>
    
    <div class="container mt-5">
        <h1>Dashboard - Tarefas Agendadas</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'message' else 'danger' }}" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if current_user.limite_tarefas == 3 %}
             <div class="alert alert-warning" role="alert">
                Bem-vindo(a) de volta! Você está no **Teste Gratuito**. Execuções restantes: **{{ 5 - tarefas|length }}** (Limite de 5).
            </div>
        {% endif %}

        {% if tarefas|length >= current_user.limite_tarefas or (current_user.limite_tarefas == 3 and current_user.executions_count >= 5) %}
            <div class="alert alert-danger" role="alert">
                Limite de **{{ current_user.limite_tarefas }} tarefas** ou **5 execuções gratuitas** atingido. Por favor, <a href="{{ url_for('planos') }}" class="alert-link">adquira um plano</a> para continuar.
            </div>
        {% else %}
            <a href="{{ url_for('nova_tarefa') }}" class="btn btn-primary mb-3">➕ Configurar Nova Tarefa</a>
        {% endif %}

        {% if tarefas %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome da Tarefa</th>
                        <th>Tipo de Filtro</th>
                        <th>Regra Ativa</th>
                        <th>Próximo Agend.</th>
                        <th>Status Recentes (3)</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tarefa in tarefas %}
                    <tr>
                        <td>{{ tarefa.id }}</td>
                        <td>{{ tarefa.nome_cliente }}</td>
                        <td>
                            {% if tarefa.filtro_tipo == 'DATA' %}
                                <span class="badge bg-primary">PRAZO (DATA)</span>
                            {% elif tarefa.filtro_tipo == 'STATUS' %}
                                <span class="badge bg-success">STATUS (TEXTO)</span>
                            {% elif tarefa.filtro_tipo == 'FUNIL' %}
                                <span class="badge bg-danger">FUNIL (BATIMENTO)</span>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if tarefa.filtro_tipo == 'DATA' %}
                                Col. {{ tarefa.coluna_data }} / {{ tarefa.dias_alerta }} dias
                            {% elif tarefa.filtro_tipo == 'STATUS' %}
                                Col. {{ tarefa.coluna_status }} = "{{ tarefa.palavra_chave }}"
                            {% elif tarefa.filtro_tipo == 'FUNIL' %}
                                Funil Ativo
                            {% else %}
                                Regra Inválida
                            {% endif %}
                        </td> 
                        <td>{{ job_info.get(tarefa.id|string, 'N/A') }}</td> 
                        <td>
                            {% set logs = log_history.get(tarefa.id, []) %}
                            {% if logs %}
                                {% for log in logs %}
                                    {% set status_char = log.status[0] %}
                                    <span class="log-icon badge {% if status_char == 'S' %}bg-success{% elif status_char == 'B' %}bg-danger{% endif %}" title="{{ log.status }} em {{ log.timestamp.strftime('%H:%M') }}">
                                        {{ status_char }}
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span class="badge bg-secondary" title="Nenhuma execução ainda">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if current_user.limite_tarefas == 3 and current_user.executions_count >= 5 %}
                                <a href="{{ url_for('planos') }}" class="btn btn-danger btn-sm me-2">Adquirir Plano</a>
                            {% else %}
                                <a href="{{ url_for('processar_agora', tarefa_id=tarefa.id) }}" class="btn btn-secondary btn-sm me-2">Executar Agora</a>
                            {% endif %}

                            <a href="{{ url_for('editar_tarefa', tarefa_id=tarefa.id) }}" class="btn btn-warning btn-sm me-2">Editar</a>
                            <form method="POST" action="{{ url_for('deletar_tarefa', tarefa_id=tarefa.id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Tem certeza que deseja DELETAR esta tarefa?')">Deletar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info mt-3">
            Nenhuma tarefa de relatório configurada para sua empresa ainda.
        </div>
        {% endif %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>